<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  header { display: flex; align-items: center; justify-content: space-between; background: #333; color: white; padding: 10px; flex-wrap: wrap; }
  header button { margin-left: 5px; font-size: 16px; }
  #scoreContainer { width: 100%; text-align: center; margin: 5px 0; }
  #score { font-weight: bold; font-size: 18px; display: inline-block; }
  #players { display: flex; flex-direction: row; padding: 10px; justify-content: space-around; }
  .teamColumn { display: flex; flex-direction: column; width: 45%; }
  .player { padding: 8px; border: 1px solid #ccc; margin-bottom: 5px; cursor: pointer; user-select: none; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 4px; transition: background 0.2s; }
  .playerHeader { font-weight: bold; text-align: center; }
  .playerStats { font-size: 13px; text-align: center; }
  .player.selected { background: #d0f0ff; border-color: #3399ff; }
  #stats { display: flex; flex-wrap: wrap; padding: 10px; }
  #stats button { flex: 1 1 20%; margin: 5px; padding: 10px; font-size: 14px; user-select: none; }
  #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  #modalContent { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90%; overflow-y: auto; }
  #teamSelect { margin-bottom: 10px; }
  .addPlayerBtn { margin-top: 5px; }
  .swapModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .swapModalContent { background:white; padding:20px; border-radius:10px; max-width:400px; }
  .playerSettingDiv { display: flex; justify-content: space-between; margin-bottom: 5px; }
  .playerSettingDiv input { width: 70%; }
</style>
</head>
<body>
<header>
  <div>
    <button id="versionBtn">V 1.3.</button>
  </div>
</header>
<header style="display:flex; flex-direction:column; padding:10px; background:#333; color:white;">
  <!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫ -->
  <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
    <!-- –õ–µ–≤–∞—è –≥—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ -->
    <div style="display:flex; gap:5px; align-items:center;">
      <button id="settingsBtn">‚öô</button>
      <button id="exportBtn">üìÑ</button>
      <button id="undoBtn">‚Ü©</button>
      <button id="resetBtn">üóë</button>
      <button id="toggleViewBtn">1</button>
    </div>
      <button id="addPointB">+1</button>
  </div>
  <div id="scoreContainer">
    <div id="score">–ö–æ–º–∞–Ω–¥–∞ –ê 0/0 –ö–æ–º–∞–Ω–¥–∞ –ë</div>
  </div>
</header>
<div id="players">
  <div class="teamColumn" id="teamAColumn"></div>
  <div class="teamColumn" id="teamBColumn"></div>
</div>
<div id="stats"></div>
<div id="modal">
  <div id="modalContent">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥</h3>
    <div id="teamSelect">
      <label><input type="radio" name="teamChoice" value="0"> –ö–æ–º–∞–Ω–¥–∞ –ê</label>
      <label><input type="radio" name="teamChoice" value="1"> –ö–æ–º–∞–Ω–¥–∞ –ë</label>
    </div>
    <div>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: <input type="text" id="teamName"></div>
    <div id="playerSettings"></div>
    <button class="addPlayerBtn">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
    <button id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>
<div class="swapModal" id="swapModal">
  <div class="swapModalContent" id="swapModalContent"></div>
</div>

<div id="versionModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px;">
    <h3>–ë—é–¥–∂–µ—Ç–Ω–∏–∫–∏ - –í–µ—Ä—Å–∏—è 1.3 - –ò–∑–º–µ–Ω–µ–Ω–∏—è</h3>
    <ul>
      <li>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—á–µ—Ç–∞. –¢–µ–ø–µ—Ä—å —Å—á—ë—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∫–∞–∫ —Å—É–º–º–∞ –æ—á–∫–æ–≤ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—è—Ç–µ—Ä–∫–∏ –∑–∞ –ø–ª–æ—â–∞–¥–∫–µ.</li>
    </ul>
    <button id="closeVersionModal">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const teamAColumn = document.getElementById('teamAColumn');
  const teamBColumn = document.getElementById('teamBColumn');
  const statsEl = document.getElementById('stats');
  const modal = document.getElementById('modal');
  const teamNameInput = document.getElementById('teamName');
  const playerSettingsEl = document.getElementById('playerSettings');
  const addPlayerBtn = document.querySelector('.addPlayerBtn');
  const saveSettingsBtn = document.getElementById('saveSettings');
  const settingsBtn = document.getElementById('settingsBtn');
  const exportBtn = document.getElementById('exportBtn');
  const swapModal = document.getElementById('swapModal');
  const swapModalContent = document.getElementById('swapModalContent');
  const undoBtn = document.getElementById('undoBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toggleViewBtn = document.getElementById('toggleViewBtn');
  const addPointB = document.getElementById('addPointB');
  const versionBtn = document.getElementById('versionBtn');
  const versionModal = document.getElementById('versionModal');
  const closeVersionModal = document.getElementById('closeVersionModal');

  let selectedTeamIndex = 0;
  let viewMode = 1;
  let teams = [{ name: '–ö–æ–º–∞–Ω–¥–∞ –ê', players: [], onCourt: [] }, { name: '–ö–æ–º–∞–Ω–¥–∞ –ë', players: [], onCourt: [] }];
  let selectedPlayer = null;
  const statKeys = ['2p','2pMiss','3p','3pMiss','ft','ftMiss','rebOff','rebDef','assist','steal','block','turnover','foulOwn','foulOpp'];
  const statNames = { '2p': '2 –æ—á–∫–∞','2pMiss': '2 –æ—á–∫–∞ –º–∏–º–æ','3p': '3 –æ—á–∫–∞','3pMiss': '3 –æ—á–∫–∞ –º–∏–º–æ','ft': '–®—Ç—Ä–∞—Ñ–Ω–æ–π','ftMiss': '–®—Ç—Ä–∞—Ñ–Ω–æ–π –º–∏–º–æ','rebOff': '–ü–æ–¥–±–æ—Ä –°–©','rebDef': '–ü–æ–¥–±–æ—Ä –ß–©','assist': '–ü–µ—Ä–µ–¥–∞—á–∞','steal': '–ü–µ—Ä–µ—Ö–≤–∞—Ç','block': '–ë–ª–æ–∫—à–æ—Ç','turnover': '–ü–æ—Ç–µ—Ä—è','foulOwn': '–§–æ–ª —Å–≤–æ–π','foulOpp': '–§–æ–ª —á—É–∂–æ–π'};
  let undoStack = [];

  function initPlayers(){
    teams.forEach(team=>{
      if(team.players.length===0){
        for(let i=1;i<=5;i++){
          let p={number:i,name:'–ò–≥—Ä–æ–∫'+i};
          statKeys.forEach(k=>p[k]=0);
          team.players.push(p);
        }
      }
      team.onCourt = team.players.slice(0,5);
    });
    renderPlayers(); renderStatsButtons(); renderScore();
  }

  function renderStatsButtons(){
    statsEl.innerHTML='';
    statKeys.forEach(k=>{
      const btn = document.createElement('button');
      btn.innerText = statNames[k];
      btn.onclick = ()=>{ if(selectedPlayer){ modifyStat(selectedPlayer,k,1); selectPlayer(selectedPlayer); } };
      statsEl.appendChild(btn);
    });
  }

  function renderPlayers(){
    if(viewMode===1){
      teamAColumn.style.display='flex';
      teamBColumn.style.display='flex';
      teamAColumn.style.width='45%';
      teamBColumn.style.width='45%';
      teamAColumn.innerHTML=''; teamBColumn.innerHTML='';
      teams[0].onCourt.forEach(p=>teamAColumn.appendChild(createPlayerDiv(p,0)));
      teams[1].onCourt.forEach(p=>teamBColumn.appendChild(createPlayerDiv(p,1)));
    } else {
      teamAColumn.style.display='flex';
      teamBColumn.style.display='none';
      teamAColumn.style.width='100%';
      teamAColumn.innerHTML='';
      teams[0].onCourt.forEach(p=>teamAColumn.appendChild(createPlayerDiv(p,0)));
    }
  }

  function createPlayerDiv(player, teamIndex){
    const div=document.createElement('div');
    div.className='player';
    if(selectedPlayer===player) div.classList.add('selected');
    div.innerHTML = `<div class="playerHeader">${player.number} ${player.name}</div><div class="playerStats">| 2 –æ—á–∫–∞: ${player['2p']}/${player['2pMiss']} | 3 –æ—á–∫–∞: ${player['3p']}/${player['3pMiss']} | –®—Ç—Ä–∞—Ñ–Ω–æ–π: ${player['ft']}/${player['ftMiss']} | –§–æ–ª: ${player['foulOwn']} |</div>`;
    let pressTimer=null;
    function startPress(e){ e.stopPropagation(); pressTimer=setTimeout(()=>{ openSwapModal(player,teamIndex); },500); }
    function endPress(e){ e.stopPropagation(); if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; selectPlayer(player); } }
    div.addEventListener('mousedown', startPress);
    div.addEventListener('mouseup', endPress);
    div.addEventListener('mouseleave', ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
    div.addEventListener('touchstart', startPress);
    div.addEventListener('touchend', endPress);
    div.addEventListener('touchcancel', ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
    return div;
  }

  function openSwapModal(player, teamIndex){
    swapModalContent.innerHTML='';
    teams[teamIndex].players.forEach(p=>{
      if(!teams[teamIndex].onCourt.includes(p)){
        const btn=document.createElement('button');
        btn.innerText=p.name;
        btn.onclick=()=>{
          const idx=teams[teamIndex].onCourt.indexOf(player);
          if(idx!==-1){ teams[teamIndex].onCourt[idx]=p; }
          swapModal.style.display='none'; renderPlayers();
        };
        swapModalContent.appendChild(btn);
      }
    });
    swapModal.style.display='flex';
  }

  swapModal.onclick=e=>{ if(e.target==swapModal){ swapModal.style.display='none'; } };

  function selectPlayer(player){
    selectedPlayer=player;
    document.querySelectorAll('.player').forEach(div=>div.classList.remove('selected'));
    document.querySelectorAll('.player').forEach(div=>{ if(div.innerText.includes(player.name)) div.classList.add('selected'); });
  }

  function modifyStat(player,key,delta){
    if(!player[key]) player[key]=0;
    player[key]+=delta;
    undoStack.push({player,key,delta:-delta});
    renderPlayers(); renderScore();
  }

  function undo(){ if(undoStack.length===0) return; const last=undoStack.pop(); last.player[last.key]+=last.delta; renderPlayers(); renderScore(); }

  toggleViewBtn.onclick=()=>{ viewMode = viewMode===1 ? 2 : 1; toggleViewBtn.innerText = viewMode===1 ? '1' : '2'; renderPlayers(); };
  addPointB.onclick=()=>{ teams[1]._extraPoint=(teams[1]._extraPoint||0)+1; renderScore(); };
  undoBtn.onclick=()=>{ undo(); };
  resetBtn.onclick=()=>{ reset(); };

  exportBtn.onclick = () => {
    try {
      let csvContent = '';
      teams.forEach(team => {
        csvContent += team.name + '\n';
        csvContent += '–ù–æ–º–µ—Ä,–ò–º—è,' + statKeys.join(',') + ',KPI\n';
        team.players.forEach(p => {
         const kpi = (p['2p'] * 2 + p['3p'] * 3 + p['ft'] + p['rebOff'] + p['rebDef'] + p['assist'] + p['steal'] + p['block'] + p['foulOpp']) - (p['2pMiss'] + p['3pMiss'] + p['ftMiss'] + p['turnover'] + p['foulOwn']);
          const row = [p.number,p.name].concat(statKeys.map(k=>p[k]), kpi.toFixed(2));
          csvContent += row.join(',') + '\n';
        });
        csvContent += '\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'basketball_stats.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch(e) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: '+e); }
  };

  const teamRadios = document.querySelectorAll('input[name="teamChoice"]');
  teamRadios.forEach(radio=>{ radio.addEventListener('change', ()=>{ selectedTeamIndex=parseInt(radio.value); loadTeamSettings(selectedTeamIndex); }); });
  settingsBtn.onclick=()=>{ modal.style.display='flex'; const checked=document.querySelector('input[name="teamChoice"]:checked'); selectedTeamIndex=checked?parseInt(checked.value):0; loadTeamSettings(selectedTeamIndex); };

  function loadTeamSettings(index){ teamNameInput.value=teams[index].name; renderPlayerSettings(); }
  function renderPlayerSettings(){ playerSettingsEl.innerHTML=''; teams[selectedTeamIndex].players.forEach((p,i)=>{ const div=document.createElement('div'); div.className='playerSettingDiv'; const numberInput=document.createElement('input'); numberInput.type='number'; numberInput.value=p.number; numberInput.oninput=()=>{ p.number=parseInt(numberInput.value); renderPlayers(); }; const input=document.createElement('input'); input.value=p.name; input.oninput=()=>{ p.name=input.value; renderPlayers(); }; div.appendChild(numberInput); div.appendChild(input); playerSettingsEl.appendChild(div); }); }
  addPlayerBtn.onclick=()=>{ const newPlayer={number:teams[selectedTeamIndex].players.length+1,name:'–ò–≥—Ä–æ–∫'+(teams[selectedTeamIndex].players.length+1)}; statKeys.forEach(k=>newPlayer[k]=0); teams[selectedTeamIndex].players.push(newPlayer); renderPlayerSettings(); };
  saveSettingsBtn.onclick=()=>{ teams[selectedTeamIndex].name=teamNameInput.value; modal.style.display='none'; renderPlayers(); renderScore(); };

  function reset(){ teams.forEach(t=>t.players.forEach(p=>statKeys.forEach(k=>p[k]=0))); teams.forEach(t=>t._extraPoint=0); undoStack=[]; renderPlayers(); renderScore(); }
  function renderScore(){ const sumA=teams[0]. players.reduce((s,p)=>s+p['2p']*2+p['3p']*3+p['ft'],0); const sumB=teams[1].players.reduce((s,p)=>s+p['2p']*2+p['3p']*3+p['ft'],0)+(teams[1]._extraPoint||0); document.getElementById('score').innerText=`${teams[0].name} ${sumA}/${sumB} ${teams[1].name}`; }

  versionBtn.onclick = () => { versionModal.style.display = 'flex'; };
  closeVersionModal.onclick = () => { versionModal.style.display = 'none'; };
  versionModal.onclick = e => { if(e.target === versionModal) versionModal.style.display = 'none'; };
  initPlayers();
});
</script>
</body>
</html>
